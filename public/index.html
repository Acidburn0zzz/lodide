<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>LodIDE</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="stylesheets/style.css" type="text/css" />
        <link rel="stylesheet" href="stylesheets/bootstrap.css" type="text/css" />
        <script src="//cdn.rawgit.com/rdf2h/rdf2h/v0.3.0/dist/rdf-ext.js"></script>
        <script src="//cdn.rawgit.com/rdf2h/rdf2h/v0.3.0/dist/rdf2h.js"></script>
        <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="//cdn.rawgit.com/rdf2h/ld2h/v0.3.0/dist/ld2h.js"></script>
        <script src="//cdn.rawgit.com/retog/rdf-store-ldp-browser/v0.3.0-rc2f/dist/rdf-store-ldp.js"></script>
        <script src="//cdn.rawgit.com/codemirror/CodeMirror/5.13.2/lib/codemirror.js"></script>
        <link rel="stylesheet" href="//cdn.rawgit.com/codemirror/CodeMirror/5.13.2/lib/codemirror.css">
        <script src="//cdn.rawgit.com/codemirror/CodeMirror/5.13.2/mode/javascript/javascript.js"></script>
        <script src="//cdn.rawgit.com/codemirror/CodeMirror/5.13.2/mode/turtle/turtle.js"></script>
        <script id="matchers" type="text/turtle">
            @prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
            @prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
            @prefix r2h: <http://rdf2h.github.io/2015/rdf2h#> .
            @prefix lodide: <http://ontology.lodide.io/> .
            @prefix dc: <http://dublincore.org/2012/06/14/dcelements#>.
            [ a r2h:Matcher ;
                    r2h:triplePattern [    
                    r2h:subject r2h:this;
                    r2h:predicate lodide:intro;
                ];
                r2h:template [ 
                    r2h:mustache '''{{{lodide:intro}}}<br/>
                                    {{{:render lodide:dataSource}}}<br>
                                    {{{:render lodide:dataProcessing}}}<br>
                                    {{{:render lodide:dataRendering}}}<br>
                                    <div class="exercise">
                                    {{{lodide:finalWords}}}
                                    </div>'''
                ]
            ].
            [ a r2h:Matcher ;
                    r2h:triplePattern [    
                    r2h:predicate lodide:dataSource;
                    r2h:object r2h:this;
                ];
                r2h:template [ 
                    r2h:mustache '''<h2>Data source</h2>
                        {{#+lodide:taskDescription}}
                        <div class="exercise">
                            {{{lodide:taskDescription}}}
                            {{#lodide:taskSolutionResource}}
                            <button id="sourceURI-solution-button">Show solution</button>
                            {{/lodide:taskSolutionResource}}
                        </div>
                        {{/+lodide:taskDescription}}
                        <div>
                            Specify the URL from which to retrieve the RDF data:
                            <input id="sourceURI" type="text" size="80" value="" />
                        </div>
                        <div style="display: none" id="sourceURI-solution">{{lodide:taskSolutionResource}}</div>'''
                ]
            ].
            [ a r2h:Matcher ;
                    r2h:triplePattern [    
                    r2h:predicate lodide:dataProcessing;
                    r2h:object r2h:this;
                ];
                r2h:template [ 
                    r2h:mustache '''<h2>Data Processing</h2>
                        {{#+lodide:taskDescription}}
                        <div class="exercise">
                            {{{lodide:taskDescription}}}
                            {{#lodide:taskSolutionCode}}
                            <button id="codeEditor-solution-button">Show solution</button>
                            {{/lodide:taskSolutionCode}}
                        </div>
                        {{/+lodide:taskDescription}}
                        <div>
                            Act on the data available as graph object <code>g</code>;
                        </div>
                        <div id="codeEditor" class="editor"></div>
                        <div style="display: none" id="codeEditor-solution">{{lodide:taskSolutionCode}}</div>'''
                ]
            ].
                    
            [ a r2h:Matcher ;
                    r2h:triplePattern [    
                    r2h:predicate lodide:dataRendering;
                    r2h:object r2h:this;
                ];
                r2h:template [ 
                    r2h:mustache '''<h2>Data Rendering</h2>
                        {{#+lodide:taskDescription}}
                        <div class="exercise">
                            {{{lodide:taskDescription}}}
                            {{#lodide:taskSolutionResource}}
                            <button id="rendering-solution-button">Show solution</button>
                            {{/lodide:taskSolutionResource}}
                        </div>
                        {{/+lodide:taskDescription}}
                        <div>Render a resource using RDF2h matchers.</div>
                        <div>Resource: <input id="rendering-resource" type="text" size="80" value="" /></div>
                        <div>RDF2h matchers:</div>
                        <div id="matchersEditor" class="editor"></div>
                        <div style="display: none" id="rendering-resource-solution">{{lodide:taskSolutionResource}}</div>
                        <div style="display: none" id="matchersEditor-solution">{{lodide:taskSolutionCode}}</div>'''
                ]
            ].
                    

        </script>
        <script>
            //From http://www.jquerybyexample.net/2012/06/get-url-parameters-using-jquery.html
            var getURLParameter = function(sParam) {
                var sPageURL = window.location.search.substring(1);
                var sURLVariables = sPageURL.split('&');
                for (var i = 0; i < sURLVariables.length; i++) {
                    var sParameterName = sURLVariables[i].split('=');
                    if (sParameterName[0] === sParam) {
                        return sParameterName[1];
                    }
                }
            };
            $(function() {
                var exerciseParam = getURLParameter("exercise");
                if (exerciseParam) {
                    $("#exercise").attr("resource", exerciseParam);
                }
                LD2h.expand();
                //This a hack because we don't know when LD2h is finished
                window.setTimeout(function() {
                    var codeEditor = CodeMirror($("#codeEditor")[0], {
                        mode: "javascript"
                    });
                    var matchersEditor = CodeMirror($("#matchersEditor")[0], {
                        mode: "turtle"
                    });
                    var run = function() {
                        var sourceURI = $("#sourceURI").val();
                        var turtleParser = LdpStore.parsers.findParsers("text/turtle")[0];
                        var store = new LdpStore({
                            parsers: new LdpStore.ParserUtil({
                                'text/turtle': turtleParser,
                                'application/ld+json': LdpStore.parsers.findParsers("application/ld+json")[0],
                                'application/rdf+xml': LdpStore.parsers.findParsers("application/rdf+xml")[0]
                            })
                        });
                        store.match(
                            null,
                            null,
                            null,
                            sourceURI,
                            function (error, g) {
                                if (!g) {
                                    console.warn("Couldn't get any triple from "+sourceURI+". reason: "+error);
                                } else {
                                    console.log("Got graph of size "+g.length+" from "+sourceURI);
                                }
                                var code = codeEditor.getValue();
                                eval(code);
                                var resource = rdf.createNamedNode($("#rendering-resource").val());
                                var matchersTurtle = matchersEditor.getValue();
                                if (matchersTurtle.length > 0) {
                                    turtleParser.parse(matchersTurtle).then(function (matchers) {
                                        var renderingResult = new RDF2h(matchers).render(
                                                g, resource);
                                        $("#result").html(renderingResult);
                                    });
                                }
                        });
                    };               
                    $("#run").on("click", run);
                
                    $("#sourceURI-solution-button").on("click", function() {
                        if (confirm("Confirm that you are you too lazy to copy and paste that URI.")) {
                            $("#sourceURI").val($("#sourceURI-solution").text().trim());
                        }
                    });
                    $("#codeEditor-solution-button").on("click", function() {
                        var message = "Confirm that you would like to see the solution.";
                        if (codeEditor.getValue().trim().length > 0) {
                            message += "\nWARNING: The code that you've already entered will be gone forever.";
                        }
                        if (confirm(message)) {
                            codeEditor.setValue($("#codeEditor-solution").text().trim());
                        }
                    });
                    $("#rendering-solution-button").on("click", function() {
                        var message = "Confirm that you would like to see the solution.";
                        if (matchersEditor.getValue().trim().length > 0) {
                            message += "\nWARNING: That code that you've already entered will be forever lost.";
                        }
                        if (confirm(message)) {
                            $("#rendering-resource").val($("#rendering-resource-solution").text().trim());
                            matchersEditor.setValue($("#matchersEditor-solution").text().trim());
                        }
                    });
                }, 300);
                
                
            });
        </script>
    </head>
    <body>
        <div id="content">
            <header>
                <div id="header" class="col-sm-12">
                    <h4><a class="brand" href="http://edulod.github.io/"><img id="logo" src="images/edulod-square.png" alt="EDULOD Logo"> EDULOD</a>
                        <small>LodIDE: Use Linked Open data!</small>
                    </h4>

                </div>
                <a href="https://github.com/edulod/lodide"><img style="position: absolute; top: 0; right: 0; border: 0;" src="images/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>    
            </header>
            <div id="exercises-index-menu">Have a look at some <a href="exercise-index.html">exercises and examples</a></div>
            <div class="intro, fetch" id="exercise" resource="empty.ttl"> </div>

            <button id="run">Run my code</button>
            <div id="result"></div>
        </div>
    </body>
</html>
